name: Ingest Recipe (append to Repo B recipes.json)

on:
  repository_dispatch:
    types: [recipe_submitted]  # must match the event_type sent by the Worker

jobs:
  append-recipe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo A
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Persist payload to file
        run: |
          set -euo pipefail
          # The worker sends JSON in github.event.client_payload.recipe
          echo '${{ toJson(github.event.client_payload.recipe) }}' > recipe.input.json

      - name: Normalize recipe JSON (optional but recommended)
        run: |
          set -euo pipefail
          node generate_recipe_json.js
          echo "JSON_FILE=generated_recipe.json" >> "$GITHUB_ENV"

      - name: Append to recipes.json in Repo B
        env:
          GH_TOKEN: ${{ secrets.generator }}   # Fine-grained PAT with Contents:read&write on Repo B
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          TARGET_REPO_OWNER="Forlgore"
          TARGET_REPO_NAME="recipe-frontend"
          TARGET_FILE_PATH="data/recipes.json"
          TARGET_BRANCH="main"

          FILE_URL="https://api.github.com/repos/$TARGET_REPO_OWNER/$TARGET_REPO_NAME/contents/$TARGET_FILE_PATH?ref=$TARGET_BRANCH"

          HTTP_STATUS=$(
            curl -sS -w "%{http_code}" -o response.json \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$FILE_URL"
          )

          NEW_ITEM="$(cat "$JSON_FILE")"
          SHA=""
          if [ "$HTTP_STATUS" = "200" ]; then
            SHA=$(jq -r '.sha' < response.json)
            jq -r '.content' < response.json | tr -d '\n' | base64 -d > current.json

            if jq -e 'type=="array"' current.json > /dev/null; then
              jq --slurp '.[0] + [.[1]]' current.json "$JSON_FILE" > merged.json
            elif jq -e 'has("recipes") and .recipes|type=="array"' current.json > /dev/null; then
              jq --slurp '.[0] | .recipes = (.recipes + [.[1]])' current.json "$JSON_FILE" > merged.json
            else
              jq --slurp '.[0], [.[1]] | add' current.json "$JSON_FILE" > merged.json
            fi
          elif [ "$HTTP_STATUS" = "404" ]; then
            jq -n --argjson item "$NEW_ITEM" '[ $item ]' > merged.json
          else
            echo "Unexpected HTTP status while reading target file: $HTTP_STATUS"
            cat response.json || true
            exit 1
          fi

          NEW_CONTENT_B64="$(base64 -w 0 < merged.json)"

          BODY="$(
            jq -n \
              --arg message "Append recipe to recipes.json (repository_dispatch)" \
              --arg content "$NEW_CONTENT_B64" \
              --arg branch "$TARGET_BRANCH" \
              --arg sha "$SHA" \
              'if $sha == "" then
                 {message:$message, content:$content, branch:$branch}
               else
                 {message:$message, content:$content, sha:$sha, branch:$branch}
               end'
          )"

          UPDATE_URL="https://api.github.com/repos/$TARGET_REPO_OWNER/$TARGET_REPO_NAME/contents/$TARGET_FILE_PATH"
          curl -sS -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "$UPDATE_URL" | tee update_response.json
